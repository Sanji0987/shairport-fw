#!/bin/bash
set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info()  { echo -e "${GREEN}[+]${NC} $1"; }
warn()  { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[x]${NC} $1"; exit 1; }

[[ "$(id -u)" -eq 0 ]] && error "Do not run as root."
command -v pacman &>/dev/null || error "This script was made for CachyOs/Arch"

info "Installing shairport-sync and checking ufw"
sudo pacman -S --needed --noconfirm shairport-sync ufw

command -v shairport-sync &>/dev/null || error "shairport-sync failed to install"
command -v ufw &>/dev/null || error "ufw failed to install"

info "Checking prerequisites..."
/usr/bin/systemctl --user is-active pipewire &>/dev/null || error "PipeWire is not running: systemctl --user start pipewire"
/usr/bin/systemctl is-active avahi-daemon &>/dev/null || { warn "Avahi is not running. Enabling..."; sudo /usr/bin/systemctl enable --now avahi-daemon; }

read -rp "AirPlay device name: " DEVICE_NAME
DEVICE_NAME="${DEVICE_NAME:-Jungle}"
DEVICE_NAME="${DEVICE_NAME//[\";\\\$\`]/}"
[[ ${#DEVICE_NAME} -gt 50 ]] && error "Device name must be 50 characters or less."

read -rsp "AirPlay password (hidden): " AIRPLAY_PASS
echo ""
[[ -z "$AIRPLAY_PASS" ]] && error "Password cannot be empty."

read -rsp "Confirm password: " AIRPLAY_PASS_CONFIRM
echo ""
[[ "$AIRPLAY_PASS" != "$AIRPLAY_PASS_CONFIRM" ]] && error "Passwords do not match."

info "Writing to shairport-sync config"
sudo /usr/bin/tee /etc/shairport-sync.conf > /dev/null << SEOF
general =
{
	name = "${DEVICE_NAME}";
	// password = "secret";
	interpolation = "soxr";
	output_backend = "pw";
	udp_port_base = 6001;
	udp_port_range = 10;
};
SEOF

info "Storing AirPlay password (read only by root in shairport-sync-password)"
printf '%s\n' "$AIRPLAY_PASS" | sudo /usr/bin/tee /etc/shairport-sync-password > /dev/null
sudo /usr/bin/chmod 600 /etc/shairport-sync-password
sudo /usr/bin/chown root:root /etc/shairport-sync-password

info "Creating firewall helper at /usr/local/bin/shairport-sync-fw"
sudo /usr/bin/tee /usr/local/bin/shairport-sync-fw > /dev/null << 'FEOF'
#!/bin/bash
set -euo pipefail
COMMENT="shairport-sync"
TCP_PORT=5000
UDP_RANGE="6001:6010"
UFW=/usr/bin/ufw
CONF=/etc/shairport-sync.conf
PASSFILE=/etc/shairport-sync-password
case "${1:-}" in
    open)
        PASS=$(<"$PASSFILE")
        PASS="${PASS//\\/\\\\}"
        PASS="${PASS//|/\\|}"
        PASS="${PASS//&/\\&}"
        /usr/bin/sed -i "s|^.*// password = \"secret\";|	password = \"$PASS\";|" "$CONF"
        $UFW allow in from 192.168.0.0/16 proto tcp to any port "$TCP_PORT" comment "$COMMENT"
        $UFW allow in from 10.0.0.0/8 proto tcp to any port "$TCP_PORT" comment "$COMMENT"
        $UFW allow in from 172.16.0.0/12 proto tcp to any port "$TCP_PORT" comment "$COMMENT"
        $UFW allow in from 192.168.0.0/16 proto udp to any port "$UDP_RANGE" comment "$COMMENT"
        $UFW allow in from 10.0.0.0/8 proto udp to any port "$UDP_RANGE" comment "$COMMENT"
        $UFW allow in from 172.16.0.0/12 proto udp to any port "$UDP_RANGE" comment "$COMMENT"
        ;;
    close)
        /usr/bin/sed -i "s|^	password = \".*\";|	// password = \"secret\";|" "$CONF"
        $UFW delete allow in from 192.168.0.0/16 proto tcp to any port "$TCP_PORT" 2>/dev/null || true
        $UFW delete allow in from 10.0.0.0/8 proto tcp to any port "$TCP_PORT" 2>/dev/null || true
        $UFW delete allow in from 172.16.0.0/12 proto tcp to any port "$TCP_PORT" 2>/dev/null || true
        $UFW delete allow in from 192.168.0.0/16 proto udp to any port "$UDP_RANGE" 2>/dev/null || true
        $UFW delete allow in from 10.0.0.0/8 proto udp to any port "$UDP_RANGE" 2>/dev/null || true
        $UFW delete allow in from 172.16.0.0/12 proto udp to any port "$UDP_RANGE" 2>/dev/null || true
        ;;
    status)
        $UFW status | grep -i "$COMMENT" || echo "No shairport-sync rules found."
        ;;
    *) echo "Usage: $0 {open|close|status}" >&2; exit 1 ;;
esac
FEOF
sudo /usr/bin/chmod 755 /usr/local/bin/shairport-sync-fw
sudo /usr/bin/chown root:root /usr/local/bin/shairport-sync-fw

info "Creating shareport command at ~/.local/bin/shareport"
mkdir -p "$HOME/.local/bin"
cat > "$HOME/.local/bin/shareport" << 'UEOF'
#!/bin/bash
set -euo pipefail
case "${1:-}" in
    start)
        /usr/bin/pkexec /usr/local/bin/shairport-sync-fw open
        /usr/bin/systemctl --user start shairport-sync
        echo "Shairport Sync started, firewall open."
        ;;
    stop)
        /usr/bin/systemctl --user stop shairport-sync
        /usr/bin/pkexec /usr/local/bin/shairport-sync-fw close
        echo "Shairport Sync stopped, firewall closed."
        ;;
    *)
        echo "Usage: $0 {start|stop}" >&2
        exit 1
        ;;
esac
UEOF
chmod +x "$HOME/.local/bin/shareport"

info "Creating systemd user service..."
mkdir -p "$HOME/.config/systemd/user"
cat > "$HOME/.config/systemd/user/shairport-sync.service" << 'DEOF'
[Unit]
Description=Shairport Sync - AirPlay Audio Receiver
After=pipewire.service

[Service]
ExecStart=/usr/bin/shairport-sync
Restart=on-failure

[Install]
WantedBy=default.target
DEOF
/usr/bin/systemctl --user daemon-reload

info "Enabling ufw"
sudo /usr/bin/ufw --force enable
sudo /usr/bin/systemctl enable ufw

echo ""
info "Setup is complete,"
echo ""
echo "  Start AirPlay:  shareport start"
echo "  Stop AirPlay:   shareport stop"
echo "  Device name:    ${DEVICE_NAME}"
echo "  Password stored in shairport-sync-password"
echo "  Ports opened only during use: TCP 5000, UDP 6001-6010 (LAN only)"
echo ""
